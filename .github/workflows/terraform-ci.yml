name: Terraform CI - Security & Quality Checks

on:
  pull_request:
    branches:
      - main
      - dev
      - staging
      - prod
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/**'
  push:
    branches:
      - main
      - dev
      - staging
      - prod
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # Job 1: Terraform Format Check
  # [Uncomment for Prod/Paid Tier] Enforces standard formatting
  # terraform-format:
  #   name:  Terraform Format Check
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@v3
  #       with:
  #         terraform_version: 1.6.0
  #
  #     - name: Terraform Format Check
  #       id: fmt
  #       run: terraform fmt -check -recursive
  #       continue-on-error: true
  #
  #     - name: Comment on PR (if format fails)
  #       if: steps.fmt.outcome == 'failure' && github.event_name == 'pull_request'
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           github.rest.issues.createComment({
  #             issue_number: context.issue.number,
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             body: ' **Terraform Format Check Failed**\n\nPlease run `terraform fmt -recursive` to format your code.'
  #           })
  #
  #     - name: Fail if format check failed
  #       if: steps.fmt.outcome == 'failure'
  #       run: exit 1

  # Job 2: Terraform Validation
  terraform-validate:
    name:  Terraform Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ['environments/dev', 'environments/staging', 'environments/prod', 'vault/dev', 'vault/staging', 'vault/prod']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.directory }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ matrix.directory }}

  # Job 3: Security Scanning with tfsec
  # [Soft Fail] Runs scan but doesn't block pipeline
  security-scan-tfsec:
    name:  Security Scan (tfsec)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true  # Don't fail build on errors
          format: sarif
          additional_args: --minimum-severity MEDIUM

      - name: Upload tfsec results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: results.sarif

  # Job 4: Security Scanning with Checkov
  # [Soft Fail] Runs scan but doesn't block pipeline
  security-scan-checkov:
    name:  Security Scan (Checkov)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true  # Don't fail build on errors
          output_format: cli,sarif
          output_file_path: console,results.sarif
          skip_check: CKV_AWS_79,CKV_AWS_23

      - name: Upload Checkov results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: results.sarif

  # Job 5: Terraform Linting
  terraform-lint:
    name:  Terraform Lint (tflint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive --format compact

  # Job 6: Cost Estimation
  cost-estimation:
    name:  Cost Estimation (Infracost)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate Infracost JSON
        run: |
          infracost breakdown --path=. \
            --format=json \
            --out-file=/tmp/infracost.json

      - name: Post Infracost comment
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost.json
          behavior: update

  # Job 7: Summary
  ci-summary:
    name:  CI Summary
    runs-on: ubuntu-latest
    needs: [terraform-validate, security-scan-tfsec, security-scan-checkov, terraform-lint]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "  Pipeline Completed. Security scans ran in Soft-Fail mode (Free Tier)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Completed:" >> $GITHUB_STEP_SUMMARY
          echo "-  Terraform Format (Skipped)" >> $GITHUB_STEP_SUMMARY
          echo "-  Terraform Validation" >> $GITHUB_STEP_SUMMARY
          echo "-  Security Scan (tfsec)" >> $GITHUB_STEP_SUMMARY
          echo "-  Security Scan (Checkov)" >> $GITHUB_STEP_SUMMARY
          echo "-  Terraform Lint" >> $GITHUB_STEP_SUMMARY

      - name: Fail if validation (critical) failed
        if: |
          needs.terraform-validate.result == 'failure' ||
          needs.terraform-lint.result == 'failure'
        run: |
          echo " Validation or Linting failed. Please review the logs."
          exit 1
