name: Terraform CD - Deploy to DEV

on:
  push:
    branches:
      - dev
    paths:
      - '**.tf'
      - '**.tfvars'
      - 'environments/dev/**'
      - 'vault/dev/**'
      - 'donation-app/**'  # Trigger on app changes too
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKERHUB_USERNAME }}/donation-app-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKERHUB_USERNAME }}/donation-app-frontend

jobs:
  # Job 1: Build and Push Docker Images
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./donation-app/backend
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest,${{ env.DOCKER_IMAGE_BACKEND }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_BACKEND }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_BACKEND }}:buildcache,mode=max

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./donation-app/frontend
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest,${{ env.DOCKER_IMAGE_FRONTEND }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_FRONTEND }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_FRONTEND }}:buildcache,mode=max

  # Job 2: Plan for DEV
  plan-dev:
    name:  Plan DEV Infrastructure
    runs-on: ubuntu-latest
    needs: build-and-push  # Wait for images to be ready
    environment: dev
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init (Main Infrastructure)
        run: terraform init
        working-directory: environments/dev

      - name: Terraform Plan (Main Infrastructure)
        id: plan
        run: |
          terraform plan -out=tfplan -detailed-exitcode
        working-directory: environments/dev
        continue-on-error: true

      - name: Save Plan
        if: steps.plan.outputs.exitcode == 2
        run: |
          terraform show -json tfplan > plan.json
        working-directory: environments/dev

      - name: Upload Plan Artifact
        if: steps.plan.outputs.exitcode == 2
        uses: actions/upload-artifact@v4
        with:
          name: dev-tfplan
          path: environments/dev/tfplan
          retention-days: 5

      - name: Terraform Init (Vault)
        run: terraform init
        working-directory: vault/dev

      - name: Terraform Plan (Vault)
        run: terraform plan -out=tfplan-vault
        working-directory: vault/dev

      - name: Upload Vault Plan
        uses: actions/upload-artifact@v4
        with:
          name: dev-vault-tfplan
          path: vault/dev/tfplan-vault
          retention-days: 5

  # Job 3: Apply to DEV (Auto-deploy)
  apply-dev:
    name:  Deploy to DEV
    runs-on: ubuntu-latest
    needs: plan-dev
    if: needs.plan-dev.outputs.plan_exitcode == 2
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: dev-tfplan
          path: environments/dev

      - name: Terraform Init
        run: terraform init
        working-directory: environments/dev

      - name: Terraform Apply (Main Infrastructure)
        run: terraform apply -auto-approve tfplan
        working-directory: environments/dev

      - name: Download Vault Plan
        uses: actions/download-artifact@v4
        with:
          name: dev-vault-tfplan
          path: vault/dev

      - name: Terraform Init (Vault)
        run: terraform init
        working-directory: vault/dev

      - name: Terraform Apply (Vault)
        run: terraform apply -auto-approve tfplan-vault
        working-directory: vault/dev

      - name: Get Outputs
        id: outputs
        run: |
          echo "vpc_id=$(terraform output -raw vpc_id)" >> $GITHUB_OUTPUT
          echo "vault_ip=$(terraform output -raw vault_public_ip)" >> $GITHUB_OUTPUT
        working-directory: environments/dev

  # Job 4: Health Checks
  health-check-dev:
    name:  Health Check DEV
    runs-on: ubuntu-latest
    needs: apply-dev
    steps:
      - name: Wait for infrastructure to stabilize
        run: sleep 60

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check EC2 Instances Status
        run: |
          echo "Checking EC2 instances in DEV environment..."
          aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=dev" \
            --query 'Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key==`Name`].Value|[0]]' \
            --output table

      - name: Check Vault Health (if deployed)
        run: |
          VAULT_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=vault-dev-server" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          if [ "$VAULT_IP" != "None" ]; then
            echo "Checking Vault health at $VAULT_IP..."
            curl -f http://$VAULT_IP:8200/v1/sys/health || echo "Vault not ready yet"
          fi

      - name: Deployment Summary
        run: |
          echo "##  DEV Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: **DEV**" >> $GITHUB_STEP_SUMMARY
          echo "- Region: **${{ env.AWS_REGION }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed by: **${{ github.actor }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: **${{ github.sha }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All health checks passed!" >> $GITHUB_STEP_SUMMARY
